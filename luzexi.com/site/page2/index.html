<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      技术人生 &middot; luzexi.com
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          技术人生
        </a>
      </h1>
      <p class="lead">我将在这里写下我毕生所学---分享是我的一直以来坚持的事,不仅仅是为别人更是为了自己</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <!-- <a class="sidebar-nav-item" href="https://github.com/luzexi/archive/v2.1.0.zip">Download</a> -->
      <a class="sidebar-nav-item" href="https://github.com/luzexi">GitHub project</a>
      <!-- <span class="sidebar-nav-item">Currently v2.1.0</span> -->
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/unity3d/%E6%B8%B8%E6%88%8F%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97/lua/2015/03/26/Unity3DLua-%E5%B0%86xls%E8%BD%AC%E5%8C%96%E4%B8%BAlua/">
        Unity3DLua-将xls转化为lua
      </a>
    </h1>

    <span class="post-date">26 Mar 2015</span>

    <p>Unity3DLua-将xls转化为lua。使用lua写unity3d项目，由于加载数据一直觉得不方便，于是写个脚本将xls数据文件转化为lua文件，这样lua逻辑就可以直接读取数据。
为什么要这样做呢？</p>

<p>首先转化为lua后就不再需要解析csv,json等数据了，可以直接使用。</p>

<p>其次，数据转乘lua后，在同步lua脚本时，可以一并同步数据。在同步环节省去了同步数据的麻烦。</p>

<p>再者，使用xls2lua脚本转化为lua数据文件，可以达到自动化校验的效果，省去一部分人为操作失误。</p>

<p>最后，我观察到很多游戏都使用这种方式，其中比较有名的是 《刀塔传奇》。其实这种方式早就很普遍了，只不过我沿着别人的足迹而已走到了这了里而已。</p>

<p>项目已经放在了github上，如果需要可以去拿。如果喜欢可以star(收藏)下。</p>

<p>Github address : <a href="https://github.com/luzexi/xls2lua">https://github.com/luzexi/xls2lua</a></p>

<p>以下是github的readme部分的文字，描述有英文和中文两个版本。你可以忽略英文部分。</p>

<h3>Excute Example (举例执行命令)</h3>
<div class="highlight"><pre><code class="language-text" data-lang="text">python ./xls2lua.py example_building.xls ./data/
</code></pre></div>
<h3>NOTICE:(注意点)</h3>
<div class="highlight"><pre><code class="language-text" data-lang="text">The sheet name must start with &quot;output_&quot; , the lua file name will be the name behind &quot;output_&quot;.
The **first row** must be **title**. 
The **second row** must be **type** 
The **type must be i , f , s , b , ai , af , as , ab.
i mean int , f mean float , s mean string , b mean bool , ai mean array int , af mean array float , as mean array string , ab mean array bool.
The **first column** must be int , so the type in first column must be i.
The string type with char **&quot;** or **&#39;** will be replace by \&quot; or \&#39; 
The empty col will be a default value like 0 or &quot;&quot; or false or {} 
(sheet名以&quot;output_&quot;开头的才会被识别转换，否则将被忽略) 
(第1行必须是关键字名) 
(第2行必须为类型) 
(类型有：i,f,s,b,ai,af,as,ab这几种) 
(i表示int，f表示float,s表示string,b表示bool,ai表示int数组,af表示float数组,as表示string数组,ab表示bool数组) 
(第1列必须为int类型的唯一关键字) 
(string类型中&quot;和&#39;会自动用\&quot;和\&#39;替代)
(空列将会被默认值代替，例如:0,&quot;&quot;,false,{})
</code></pre></div>
<h3>Lua script (生成后的Lua文件示例)</h3>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="c1">-- this file is generated by program!</span>
<span class="c1">-- don&#39;t change it manaully.</span>
<span class="c1">-- source file: example_building.xls</span>
<span class="c1">-- created at: Thu Mar 26 02:53:52 2015</span>

<span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">house&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mf">2.33</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{</span><span class="mf">1.23</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">3.23</span><span class="p">},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">sdf&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">23e&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">s&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">}}</span>
<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">house2&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">123</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mf">336.2</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mf">2.3445</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">你好&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">你在哪&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">}}</span>
<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">456</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mf">222.33665</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">130</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">我在这里啊&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">你在那&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">呢&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">}}</span>
<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">farm&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mf">220.0</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{</span><span class="mf">200.3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mf">234.23</span><span class="p">},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">df&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">ssd&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">dd&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">dd&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{}}</span>
<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">house5&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mf">22.1</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">234</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mf">6.3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">ss&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">d&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">d&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">d&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{</span><span class="kc">true</span><span class="p">,</span><span class="kc">true</span><span class="p">}}</span>
<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">horse3&quot;</span><span class="p">,</span>  <span class="n">use_money</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>  <span class="n">use_food</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">is_init</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>  <span class="n">defense</span> <span class="o">=</span> <span class="mi">333</span><span class="p">,</span>  <span class="n">aadd</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">aadddss</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">ddff</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="s">2e&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">w&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">e&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">we&quot;</span><span class="p">},</span>  <span class="n">ffdd</span> <span class="o">=</span> <span class="p">{</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">false</span><span class="p">}}</span>

<span class="k">return</span> <span class="n">data</span>
</code></pre></div>
<h3>How to use lua with data. (如何使用生成的lua数据)</h3>
<div class="highlight"><pre><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">building</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">&quot;</span><span class="s">building&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">building</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>
<p>The console will print &quot;house&quot;</p>

<p>转载注明出处 http://www.luzexi.com</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/unity3d/%E6%B8%B8%E6%88%8F%E6%9E%B6%E6%9E%84/2015/03/06/Unity3D%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83%E5%85%A8%E9%83%A8%E7%BD%B2/">
        Unity3D项目环境全部署
      </a>
    </h1>

    <span class="post-date">06 Mar 2015</span>

    <p>Unity3D项目环境全部署。这次我想总结下项目环境部署。可别小看了这个开发环境部署，这将直接导致项目的进程速度，以及成员们在这个开发行程中的疲劳积累速度。优秀的部署能省去成员们不必要的心理负担，卸下包袱专心去做自己的功能块。差劲的部署，会加重成员们的心理负担，并且有可能引起不必要的开发冲突。</p>

<p>首先我来罗列下Unity3D开发手游需要经历哪些节点。</p>

<p>1.Unity3D内编码。里面的内容自然主要是架构与编码，本篇不对其细说。</p>

<p>2.IOS,Android  SDK接口对接。不同的平台，不同的sdk对接。</p>

<p>3.项目进度监督与管理，所有策划案与修改案都会被记录在项目进度表中，每周都需要一个报告来支撑项目进度。项目的进度跟踪是对项目进度把控的最好体现。</p>

<p>4.测试部门的bug提交，与用户体验建议&amp;修改。这将极大的完善游戏体验，让bug与差体验都尽可能得消失殆尽。</p>

<p>5.wiki面板。这将项目中的重大事件与注意事项进行记录，共所有人查阅，以方便在开发中查阅前面所经历的问题，缩短询问时间。</p>

<p>6.策划案数据自动生成。策划案的数据在开发过程中随时都会进行改变，一键生成数据并同步到程序，反应到客户端是加快项目速度的好方法，也同时消除了成员们手动操作的心理负担。</p>

<p>7.一键生成需要动态加载的资源与资源版本号，有些还需要对动态资源进行zip压缩打包。很多游戏都会在游戏的开头，或游戏中进行加载资源，开发中这些资源都会随时随地的被成员们改变，一键生成将加快项目进度，消除成员们手动操作的心理负担。</p>

<p>8.打包成不同平台的包。ios-&gt;ipa , android-&gt;apk (android这里还有不同的游戏平台游戏包，一个游戏至少会有20个平台需要接，每个平台1个包)，winphone也一样。</p>

<p>9.将包上传至内部服务器供，测试部门以及项目成员们测试&amp;预览。ios可以用testFlight，也可以用协议在网页上自行下载安装。android和winphone不用说可以放内部网页直接下载安装。</p>

<p>以上是所有开发需要的步骤，包括了 主逻辑开发，平台对接，项目管理，测试管理，备忘录，数据同步，资源打包，客户端打包，以及客户端同步。</p>

<p>这些都只是称述而已，那么如何将这些部分连起来呢。看下图：
<img class="alignnone size-full wp-image-501" src="/assets/uploads/2015/03/客户端环境布局.jpg" alt="客户端环境布局" width="711" height="486" />能看明白吗，容我解释下(其实上面也有一部分称述)：</p>

<p>点1和2=&gt;使用git版本控制，建立主分支，各功能块拆分成不同分支并行开发，在主分支上建立ios,android,winphone平台分支，这里只写平台代码逻辑代码从主分支获取。</p>

<p>点3和4和5=&gt;使用redmine(当然也可以用别的管理)，建立wiki写备忘录，提供测试与体验提交问题，并且使用office软件与email编写进度报表共成员们查阅。</p>

<p>点6=&gt;用python(也可以ruby,php...等等自己选)解析xls生成数据并上传。</p>

<p>点7=&gt;这里可以用python语言也可用jenkins来执行资源打包程序，并上传。</p>

<p>点8=&gt;使用jenkins打包，建立&amp;配置打包流程，随时随地可以一键打包，使得打包快速、准确、稳定。</p>

<p>点9=&gt;ios可以用testFlight，也可以用协议在网页上自行下载安装。android和winphone不用说可以放内部网页直接下载安装。</p>

<p>总结：尽量将各部门的合作用自动化的形式融合在一起，维护好自动化程序与合作流程，让各个成员们都只关注自己的部分。最终目的就是加快开发速度，减少成员疲劳度积累(避免是不可能的)。</p>

<p>另外题外话----附上web服务器的项目布局，见下图。</p>

<p><img class="alignnone size-full wp-image-510" src="/assets/uploads/2015/03/服务端开发环境布局.jpg" alt="服务端开发环境布局" width="686" height="468" /></p>

<p>转载请注明出处：http://www.luzexi.com</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/unity3d/%E7%94%9F%E6%B4%BB/2015/02/11/Unity3D%E4%B8%8A%E6%B5%B7CTO&Leader%E8%AE%A8%E8%AE%BA%E4%BC%9A/">
        Unity3D上海CTO&Leader讨论会
      </a>
    </h1>

    <span class="post-date">11 Feb 2015</span>

    <p>今天去了趟unity上海分部的CTO&amp;Leader讨论会。记录下会议内容很多无聊的东西我都略过不写了，报告下我们比较关心的，或者将来会遇到的困难。
1.现在unity3d 4.6.2 打包64位的ios app 不靠谱，bug有400多个，不建议升级。4月1号前说是会出个稳定版，但讨论中透露，稳定版中也会由许多未知因素。IL2P打成c++的方式有众多问题和困难。</p>

<p>2.他们说了个热更新的解决方案，但只限安卓。我听了下，原理就是把所有程序都打成一个dll，用加载资源的方式加载，然后再实时编译。这个要求代码不能附着在prefab上。然后我说了关于使用lua更新机制，虽然现在在u3d里仍不是非常成熟，但困难是永远都有的，各位可以值得一试，不要等到别人用熟了你才开始，那已经慢了好大一步了。</p>

<p>3.问了关于内存释放的问题，他们阐述说resources.unloadunusedassets并不是根据引用计数来释放内存，而是根据世界树中的实例检测，而System.GC.Collect()是根据引用计数销毁的，所以可以选择两个一起使用，也就是我们现在的方式。</p>

<p>4.关于内存，他们在阐述他们提供的一个性能测试服务中，提到由于ngui底层是mesh重构，而每次重构都会积累内存消耗，所以ngui的内存问题是比较严重，他们暗示项目使用unity自己的ugui。</p>

<p>5.关于混淆，他们只有一般的混淆方案。网上可以找到。没什么特别的自己方案。混淆的注意点是，混淆时安卓和ios等平台对接的接口不要进行混淆，在平台调用时会找不到相应接口。unity技术团队说他们可以提供混淆服务，但我觉得并不困难。</p>

<p>6.unity5 将与unity4完全不同，互不兼容，也就是像cocosx 2与cocosx 3一样，拆分两个版本维护。IL2P将会逐渐替代mono的打包方式。mono也很难升级，因为高版本的授权费用很高，一般的用户承受不了。</p>

<p>7.以下是一些unity5比较有用的改善。没兴趣关注的就不提了。</p>

<p>*场景中的shader可以自动合并成一个shader，减低drawcall。但我怎么觉得这里面有好多空噱头。
*assetbundle打包可以进行增量更新，无变化的assetbundle会被自动识别，加快了批量打assebbundle的速度。
*更多得采用多线程处理，加快unity应用的速度。
*支持webGL平台的开发。在支持webGL浏览器里不需要unity插件。
*unity5升级为64位，编辑器可使用更多内存。</p>

<p>8.最后他们提供说一个真机性能测试的服务，可以提供60页的性能测试报表，其实我觉得没什么用。性能卡点自己找起来比较准确点。
<img class="alignnone size-full wp-image-487" src="/assets/uploads/2015/02/IMG_0972.jpg" alt="IMG_0972" width="1763" height="885" /></p>

<p>转载注明出处 http://www.luzexi.com</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/lua/2015/01/21/Lua%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%AE%B0/">
        Lua使用实记
      </a>
    </h1>

    <span class="post-date">21 Jan 2015</span>

    <p>c调用lua堆栈常用操作-------
===================初级========================
void lua_gettop() : 用于返回栈中元素的个数，同时也是栈顶元素的索引，因为栈底是1，所以栈中有多少个元素，栈顶索引就是多少。</p>

<p>void lua<em>settop(int index) : 设置栈顶，也是设置栈的大小，多的去除，少的填nil。-- #define lua</em>pop(L,n) lua_settop(L,-(n)-1)</p>

<p>void lua_pushvalue(int index) : 拷贝索引index元素并压入栈。</p>

<p>void lua_remove(int index) : 删除索引index。</p>

<p>void lua_replace(int index) : 弹出栈顶元素，并将其替换到索引index元素。</p>

<p>void lua_getglobal(const char *name) : 把全局变量name压入栈顶。</p>

<p>void lua_pop(int n) : 推出栈顶(移除)n个元素。</p>

<p>void lua_insert(int index) : 弹出栈顶，并将其插入索引index中。</p>

<p>void lua_remove(int index) : 移除索引index的元素。</p>

<p>lua_is***(int index) 检查变量是不是某个类型，index指示变量的顺序，栈顶为-1。</p>

<p>lua_to***(int index) 获取栈中的变量，然后转换为某个指定的类型，并返回。</p>

<p>lua_push***() 压入某类型元素。</p>

<p>int lua_type(int index) : 获得索引index的值的类型。</p>

<p>===================中级========================
void lua_call(int nargs, int nresults) : 调用方法，其中nargs为参数数量，nresults为结果数量。栈中必须保持  ..... func , arg1 , arg2 ,art3 (<em>) ，</em>表示栈顶，调用后func,arg都会消失，只留下结果，如果调用没有问题的话。</p>

<p>int lua_pcall(int nargs, int nresults, int errfunc) :  功能pcall与call一样，区别在最后多了个自定义错误处理，当调用出错后，会调用其栈中索引方法。pcall返回0为无错误，其他则表示调用有错。如果errfunc为0，则报错调用原始方法。</p>

<p>void lua_createtable(int narr, int nrec) : 创建一个narr行nrec列的table，将其压入栈。</p>

<p>void lua<em>newtable() : 创建一个空表，将其压入栈。与lua</em>createtable(0,0)一个意思。</p>

<p>void lua<em>getfield(int index, const char *k) :  t[k]，获取表(索引为t的表)中的k值，并压入栈。这个会调用被修改的</em>_index的方法，如果被修改过的话。</p>

<p>void lua_setfield(int index, const char *k) : 设置t[k] = v，t为索引index的表，k为参数k值，v为栈顶元素，并弹出栈顶元素。此调用会触发修改过的newindex方法。</p>

<p>void lua_getglobal(const char *name) : 获取全局变量name，并压入栈顶。</p>

<p>void lua_setglobal(const char *name) : 弹出栈顶，并将其设置为全局变量name的值。</p>

<p>void lua<em>gettable(int index) : 弹出栈顶，并压入t[k]值，t为索引index的表，k为栈顶值。此方法将调用被修改的</em>_index的方法，如果被修改过的话。</p>

<p>void lua<em>settable(int index) : 设置表t[k]=v，t为索引index的表，v是栈顶元素，k为栈顶下面一个元素。例如 lua</em>settable(-3)  ---- table , &quot;key&quot; , &quot;value&quot; (<em>) ，</em>表示栈顶。并弹出v(栈顶)和k(栈顶下面)元素，此调用会触发修改过的newindex方法。</p>

<p>void lua_rawget(int index) : 与gettable一样，但调用的索引方法是原始的。</p>

<p>void lua_rawset(int index) :  与settable一样，但调用的索引方法是原始的。</p>

<p>void lua_rawgeti(int index, int n) : 压入t[n]值，t为索引index的表，n为参数n，调用的索引方法是原始的。</p>

<p>void lua_rawseti(int index, int n) : 设置t[n]=v，t为索引index的表，v为栈顶值，n为参数n，并弹出栈顶元素。调用的索引方法为原始的。</p>

<p>int lua_getmetatable(int index) : 压入索引index的值的metatable，如果索引index的值有metatable则返回非0，否则返回0并不压入任何元素。</p>

<p>int lua_setmetatable(int index) : 弹出栈顶，并将其设置为索引index值的metatable。</p>

<p>void lua<em>register(const char *name, lua</em>CFunction f) :  向lua注册名字为name的f方法。这个方法相当于 #define lua<em>register(L,n,f) (lua</em>pushcfunction(L, f), lua_setglobal(L, n))</p>

<p>转载请注明出处：http://www.luzexi.com</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/unity3d/%E6%B8%B8%E6%88%8F%E6%9E%B6%E6%9E%84/%E6%B8%B8%E6%88%8F%E9%80%9A%E7%94%A8%E6%A8%A1%E5%9D%97/2014/11/23/Unity3D%E6%89%8B%E6%9C%BA%E4%B8%AD%E7%9A%84%E7%BD%91%E9%A1%B5%E8%B0%83%E7%94%A8%E4%B8%8E%E5%9B%9E%E8%B0%83/">
        Unity3D手机中的网页调用与回调
      </a>
    </h1>

    <span class="post-date">23 Nov 2014</span>

    <p>Unity3D手机中的网页调用与回调，其实就是我们口中常说的Webview，是手机项目里调用网页，来代替游戏画面展示的一种方法。因为其展示的是网页，所以展示画面是相对动态的，可以由服务器来控制。但是我们不只需要展示画面，还需要当点击网页按钮时产生回调以使U3D执行指定程序。</p>

<p>其实日本在webview这个模块上做的很不错，我也是借用日本Gree公司在github上公开的webview程序来作为底层代码的，只是我稍微改进了下，以适合自己的程序习惯和项目习惯。下面我主要介绍下这个webview的运作机制。</p>

<p>一、调用Webview打开网页。
我在源码基础上加了个单例接口，使得接口调用更加简单。</p>

<p>初始化接口：WebViewObject.sInstance.Init((msg)=&gt;{
Debug.Log(string.Format(&quot;CallFromJS[{0}]&quot;, msg));
}); 初始化传入的是点击回调的消息接口。</p>

<p>设置窗体大小：WebViewObject.sInstance.SetMargins(5, 5, 5, 40); 窗体大小定义的十左边，上边，右边，下边的间隔像素。</p>

<p>展示OR关闭网页：WebViewObject.sInstance.SetVisibility(true);</p>

<p>通过地址加载某网页：WebViewObject.sInstance.LoadURL(path);</p>

<p>二、Webview在不同平台的插件载体和编译这些载体的方法。</p>

<p>这里主要是Android、IPHONE和MAC平台---因为它只做了这3个平台，所以Windows平台的同学就不能再编辑器里看到了，调试Webview时就用MAC吧。Android使用jar做插件体，iphone用.mm文件做插件体，mac用bundle做插件载体。</p>

<p>iphone是用.mm文件，所以不用编译载体，只有Android和Mac需要。在platform<em>src/Android和platfor</em>src/iOS下分别有install.ssh文件可以执行，用来编译各自的载体。所以你只要执行就可以了。</p>

<p>三、Webview网页按钮回调。</p>

<p>Webview网页按钮回调的功能对我们来说非常有用，所以这里细致讲下它是如何辨认并回调的。
所有的网页里的链接都可以想象成按钮，无论是图片超链接还是普通的链接地址，更或是form形式的submit提交按钮，都是以网页形式访问网页地址。当访问网页地址时，native程序中拦截了网页地址，并查看网页地址是否以&#39;unity:&#39;打头，如果是以&#39;unity:&#39;打头的认为是调用unity3d的按钮，将此地址直接发送(SendMessage)给U3D的Webview程序，让其判断根据接收到得地址判断需要调用哪段程序。比如，地址为unity:auth，U3D程序在init时传入的接口接收到的为auth的字符串。所以如果你想让网页链接调用U3D程序，你就把链接写成unity:开头的超链接。</p>

<p>最后，我们既然有了手机中得网页调用与回调，我们就可以充分运用其在游戏里的功能了，最最基础的就是公告了，其次就是攻略网页，还有游戏功能的说明和调用，甚至有时可以直接代替游戏画面，直接替换画面的灵活性就非常强大了。</p>

<p>现在，我连Webview的测试案例都写好，测试案例的项目在git clone 后切记使用 git submodule update --init 更新submodule。：）Good luck!</p>

<p>注：有人反馈显示网页后，点击奔溃的问题，这是U3D的Editor本身与MAC兼容的问题，U3D编辑器的调用MAC程序奔溃比较频繁，所以细致的测试还得在真机上进行比较合适。</p>

<p><img class="alignnone size-full wp-image-450" src="/assets/uploads/2014/11/img.png" alt="img" width="1408" height="960" /></p>

<p>源码地址：<a href="https://github.com/luzexi/Unity3DWebView">Unity3DWebview</a></p>

<p>测试案例地址：<a href="https://github.com/luzexi/Unity3DWebView-Test">Unity3dWebviewTest</a></p>

<p>转载请注明出处：http://www.luzexi.com</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>
    </div>

  </body>
</html>
