<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta content="" name="description">


  <title>
    
      技术人生 &middot; www.luzexi.com
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css?version=20180701">
  <!-- <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"> -->

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

  	<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          技术人生
        </a>
      </h1>
      <p class="lead">漫漫人生,记录点滴技术,始于2013</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      <a class="sidebar-nav-item" href="/书籍著作/index.html">书籍著作</a>
      <a class="sidebar-nav-item" href="/Unity3D/index.html">Unity3D</a>
      <a class="sidebar-nav-item" href="/游戏通用模块/index.html">游戏通用模块</a>
      <a class="sidebar-nav-item" href="/前端技术/index.html">前端技术</a>
      <a class="sidebar-nav-item" href="/后端技术/index.html">后端技术</a>
      <a class="sidebar-nav-item" href="/其他技术/index.html">其他技术</a>
      <a class="sidebar-nav-item" href="/金融投资/index.html">金融投资</a>
      <a class="sidebar-nav-item" href="/life/index.html">Life</a>

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/Util-page.html">常用页面工具</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about.html">About Me</a>
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/engineer-shopping.html">程序员必需品</a>
          
        
      
        
      
        
          
            <a class="sidebar-nav-item" href="/friendlink.html">友情链接</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
      
        
      
      
      <a class="sidebar-nav-item" href="https://github.com/luzexi">GitHub project</a>
      <a href="http://www.luzexi.com/assets/feed.xml">RSS feed</a>
      <!-- <span class="sidebar-nav-item">Currently v2.1.0</span> -->
    </nav>

    <p>&copy; 2019. All rights reserved.</p>
    <p>浙ICP备13028172号-1</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/01/26/Unity3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%BF%9B%E9%98%B6%E4%B8%BB%E7%A8%8B-CSharp%E8%A6%81%E7%82%B9%E6%8A%80%E6%9C%AF4.html">
        《Unity3D高级编程之进阶主程》第一章，C#要点技术(四)
      </a>
    </h1>

    <span class="post-date">26 Jan 2019</span>

    <h3>委托(delegate)与事件(Event)的实质</h3>

<p>使用过C或C++的同学都对指针很清楚，指针是个需要谨慎对待的东西，它不仅仅可以指向变量的地址，还可以指向函数的地址，本质上它是指向内存的地址。</p>

<p>在C#中，万物接是类，大部分时间里都没有指针的身影，因为指针被封闭在内部函数当中。可是回调函数却依然存在，它是以委托的方式来完成的。委托可以被视为一个更高级的指针，它不仅仅能把地址指向另一个函数，而且还能传递参数，返回值等多个信息。系统还为委托对象自动生成了同步、异步的调用方式，开发人员使用 BeginInvoke、EndInvoke 方法就可以抛开 Thread类 而直接使用多线程调用。</p>

<p>创建委托其实就是创建了一个delegate类实例，创建委托时就相当于这个类继承了System.MulticastDelegate类，类实例里有，BeginInvoke、EndInvoke、Invoke三个函数，分别表示，异步开始调用，结束调用，直接调用。</p>

<p>不过我们不能直接写个类来继承System.MulticastDelegate类，因为它不能被继承在明文上，它的父类Delegate类也同样有这个规则，官方文档中写的就是这么个规则：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>    MulticastDelegate is a special class. Compilers and other tools can derive from this class, but you cannot derive from it explicitly. The same is true of the Delegate class.
</code></pre></div>
<p>delegate类中有个变量是用来存储函数地址的，当变量操作 =(等号) 时，把函数地址赋值给变量存起来。不过这个存储函数地址的变量是个可变数组，你可以认为是个链表，每次直接赋值时会换一个链表。</p>

<p>委托类还重写了 +=，-= 操作符，其实就是对应 MulticastDelegate 的 Combine 和 Remove 方法，当对函数操作 += 和 -= 时，相当于把函数地址推入了链表尾部，和移出了链表。</p>

<p>当委托被调用时，委托实例会把所有链表里的函数依次按顺序用传进来的参数调用一遍。官方文档中写的就是如上述所说：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>A MulticastDelegate has a linked list of delegates, called an invocation list, consisting of one or more elements. When a multicast delegate is invoked, the delegates in the invocation list are called synchronously in the order in which they appear. If an error occurs during execution of the list then an exception is thrown.
</code></pre></div>
<p>所以说，delegate关键字其实只是个修饰用的单词，背后都是由C#编译器来重写代码的，就相当于在编译时把delegate这一句换掉，变成class并继承System.MulticastDelegate的类。</p>

<p>那么什么是event？</p>

<p>event 很简单，它在委托delegate上，又做了一次封装，这次封装的意义是，限制用户直接操作委托变量的权限。</p>

<p>封装后，用户不再能够直接用赋值(=等号操作符)操作来改变委托变量了，只能通过注册或者注销委托的方法来改变委托变量。也就是说被event声明的委托不再提供‘=’的操作符，但仍然有 += 和 -= 的操作符可供操作。</p>

<p>为什么要限制？</p>

<p>因为公开的委托会直接暴露在外，随时会被‘=’赋值而清空了前面累积起来的委托链表，造成不可预测的问题。申明 event 后，编译器内部重新封装了委托，让暴露在外面的委托不再担心随时被清空和重置的危险了。因为经过 event 封装后不再提供赋值操作来清空前面的累加，只能一个个注册或者一个个注销委托(或者说函数地址)。</p>

<h3>装箱和拆箱</h3>

<p>什么是装箱和拆箱。</p>

<p>很简单，把值类型实例转换为引用类型实例，就是装箱。</p>

<p>相反，把引用类型实例转换为值类型实例，就是拆箱。</p>

<p>再简单点：</p>

<p>int a = 5;</p>

<p>object obj = a;</p>

<p>就是装箱</p>

<p>继续上面代码</p>

<p>a = (int)obj;</p>

<p>就是拆箱。</p>

<h6>为何需要装箱。</h6>

<p>值类型是在栈中分配内存，在声明时初始化才能使用，不能为null。 </p>

<p>引用类型在堆中分配内存，初始化时默认为null。 </p>

<p>值类型有，所有整数，浮点数，bool，以及 Struct 申明的结构</p>

<p>引用类型有，类，接口，委托(委托也是类)，数组以及内置的object与string。</p>

<p>这里又引申出来，为什么要分栈内存和堆内存，简单快速阐述下：</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>    栈是本着先进后出的数据结构(LIFO)原则的存储机制, 对栈数据的定位比较快速, 而堆则是随机分配的空间, 处理的数据比较多, 无论如何, 至少要两次定位。堆内存的创建和删除节点的时间复杂度是O(logn)。栈创建和删除的时间复杂度则是O(1)，栈速度更快。

    既然栈速度这么快，全部用栈不就好了。这又涉及到生命周期问题，由于栈中的生命周期是必须确定的，创建后什么时候销毁是一个定量，所以在分配和销毁时不灵活，相反堆内存可以存放生命周期不确定的内存块，满足当需要删除时再删除的需求，所以堆内存相对于引用类型的内存块更适合。
</code></pre></div>
<p>因此在当栈内存和堆内存相互转换时，有了装箱和拆箱的过程。大部分时候只有当程序、逻辑或接口需要更加通用的时候才会需要装箱。</p>

<p>比如调用一个含类型为object的参数的方法，该object可支持任意为型，以便通用。当你需要将一个值类型(如Int32)传入时，就需要装箱。</p>

<p>又比如一个非泛型的容器，同样是为了保证通用，而将元素类型定义为object。于是，要将值类型数据加入容器时，需要装箱。</p>

<p>我们来看看装箱的内部操作。</p>

<p>装箱： 对值类型在堆中分配一个对象实例，并将该值复制到新的对象中。按三步进行。 </p>

<p>第一步：在堆内存中新分配一个内存块(大小为值类型实例大小加上一个方法表指针和一个SyncBlockIndex)。 </p>

<p>第二步：将值类型的实例字段拷贝到新分配的内存块中。 </p>

<p>第三步：返回内存堆中新分配对象的地址。这个地址就是一个指向对象的引用了。 </p>

<p>拆箱：检查对象实例，确保它是给定值类型的一个装箱值。将该值从实例复制到值类型变量中。</p>

<h6>装箱、拆箱对执行效率有哪些影响，如何优化。</h6>

<p>由于装箱、拆箱时生成的是全新的对象，不断得分配内存会有时间损耗和CPU的消耗，降低性能。 那该如何做呢？</p>

<p>这里提到的拆装箱优化，都是针对 Struct 结构类型的，由于整数、浮点数、布尔等数值型变量的变化手段很少，变不出什么花花来，但 Struct 不一样，它既是值类型存放在栈内存上，又可以像类一样继承，用途多，转换的途径多，可变的花花也多。稍不留神，花花就变成了麻烦，所以这里重点讲的是 Struct 变出花花后的优化方法。</p>

<p>1、Struct 通过重载函数来避免拆箱、装箱。</p>

<p>比如常用的ToString()，GetType()方法，如果 Struct 没有写重载ToString()和GetType()的方法，就会在 Struct 实例调用它们时先装箱再调用，导致内存块重新分配性能损耗。所以对于那些需要调用的引用方法，必须重载。</p>

<p>2、通过泛型来避免拆箱、装箱。</p>

<p>不要忘了 Struct 也是可以继承的，在不同的、相似的、父子关系的 Struct 之间可以用泛型来传递参数，这样就不用装箱后再传递了。</p>

<p>比如B,C继承A，就可以有这个泛型方法 void Test<T>(T t) where T:A，以避免使用object引用类型形式传递参数。</p>

<p>3、通过继承统一的接口提前拆箱、装箱，避免多次重复拆箱、装箱。</p>

<p>多种 Struct 继承接口后，不同的 Struct 就可以有相同的接口了。把 Struct 传递到其他方法里去时就相当于提前进行了装箱操作，在方法中得到的是引用类型的值，并且有它需要的接口，避免了在方法中重复多次的拆装箱操作。</p>

<p>比如 Struct A 和 Struct B 都继承接口 I，void Test(I i)。当调用Test方法时传进去的 Struct A 或 Struct B 的实例都相当于提前做了装箱操作，Test里拿到的参数就不用再担心装箱拆箱问题了。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/01/19/Unity3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B%E4%B9%8B%E8%BF%9B%E9%98%B6%E4%B8%BB%E7%A8%8B-CSharp%E8%A6%81%E7%82%B9%E6%8A%80%E6%9C%AF3.html">
        《Unity3D高级编程之进阶主程》第一章，C#要点技术(三)
      </a>
    </h1>

    <span class="post-date">19 Jan 2019</span>

    <p>直接开门见山了。</p>

<h3>浮点数的精度问题</h3>

<p>平常极少使用double类型，因为浮点数计算我们也并没有使用到特别的科学计算部分，所以float基本都够用，而且double也同样有精度问题，无论怎么样都是无法避免精度问题在项目里的危害的。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/01/12/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A819.html">
        思路探讨(十九) 机会
      </a>
    </h1>

    <span class="post-date">12 Jan 2019</span>

    <p>谈了很久的人生和哲学，灌了很多人生鸡汤，多了也有负效果，因为没有付诸于行动效果等于没有，天天空想哲学问题时间长了也等于在浪费时间。</p>

<p>以前有段时间很不明白为什么有人说鸡汤多了副作用也大，明明是好的文章，讲得道理也很有意义，对自身的激励也很好，为什么就会有副作用呢。</p>

<p>后来才渐渐明白，看多了没有在实际中体现出其具体价值也属于浪费时间，浪费生命，纸上谈兵。天天畅想着未来，嘴上说着坚持，脑袋里想着高科技，手里却什么都不干，干不了，不敢干，其实也没什么用，境界再高，也是假境界，说的再牛，也是打肿脸充胖子，迟早是要露馅的。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/01/05/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A818.html">
        思路探讨(十八) 所有不确定都是机会
      </a>
    </h1>

    <span class="post-date">05 Jan 2019</span>

    <p>以前不明白为什么，不确定是机会，随着自己经历的丰富，渐渐明白了。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2019/01/01/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A817.html">
        思路探讨(十七) 2018形势和心态
      </a>
    </h1>

    <span class="post-date">01 Jan 2019</span>

    <p>2018开年感觉还是不错的，虽然没有红红火火，但平淡中带点小火花还是有的，现在看来当时还是偏乐观的。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/12/26/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A816.html">
        思路探讨(十六) 感官动物
      </a>
    </h1>

    <span class="post-date">26 Dec 2018</span>

    <p>最近半年的写思路文章的经历让自己学到很多东西。工作非常的繁忙，纵使我降低了书写的频率，还是很难抽出时间来专心写作，只能靠每天的碎片时间来思考这周的主题，并在印象笔记里记录我的思考过程和结论。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/12/15/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A815.html">
        思路探讨(十五) 中产阶层的天花板
      </a>
    </h1>

    <span class="post-date">15 Dec 2018</span>

    <p>很多人应该跟我一样，曾有段时间一直怀疑社会阶层是否真的存在，或者幻想着它是以何种形式存在的。</p>

<p>社会阶层确实存在是事实不可否认的，它到底以何种形式存在，是很多人包括我自己所迷惑的。</p>

<p>大部分人还是把阶层的概念停留在’钱‘上，这种不假思索的观念只能说只对了一小部分。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/12/08/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A814.html">
        思路探讨(十四) 要行动，不要焦虑
      </a>
    </h1>

    <span class="post-date">08 Dec 2018</span>

    <p>人生大多数遇到的难题都不是能单靠几个小时或者几天就能解决的。很多人不愿意接受这个事实，总是试图靠短时间内的突击行动来试图解决长期的问题，那是不可能的事，而且大概率会让事情变得越来越糟糕，身体坏了，健康没了，事情没成，问题没解决，一切变得愈发糟糕。</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/12/01/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A813.html">
        思路探讨(十三) 三十而立四十不惑
      </a>
    </h1>

    <span class="post-date">01 Dec 2018</span>

    <h6>三十立什么？</h6>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/11/22/%E6%80%9D%E8%B7%AF%E6%8E%A2%E8%AE%A812.html">
        思路探讨(十二) 思维突破
      </a>
    </h1>

    <span class="post-date">22 Nov 2018</span>

    <p>人很难突破自己的思维，因为我们自己很难知道自己的思维是否固化，也很难从其他人口中了解到。</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">下一页</a>
  
  
    <span class="pagination-item newer">上一页</span>
  
</div>
    </div>

    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f3d58556a7396e715b3602ef6754cd91";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  </body>
  
</html>
