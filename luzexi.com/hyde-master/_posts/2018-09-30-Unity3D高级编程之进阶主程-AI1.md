---
layout: post
status: publish
published: false
title: 《Unity3D高级编程之进阶主程》AI(1)-状态机构建智能机器人
description: "unity3d 高级编程 主程 地图 navmesh 寻路"
excerpt_separator: ===
tags:
- 书籍著作
- Unity3D
- 前端技术
---

AI机器人在游戏中非常普遍，它们常以模仿人类的行为在游戏中活动。


### AI-状态机

状态机虽然是个比较简单的概念，但在实际编程中花样也是繁多的，最终都是围绕着状态这个基础变量来做变化的。

状态机最符合人类思考的方式，我们喜欢把事物以状态形式进行拆分成：当前状态，前置状态，下一个状态，状态变化需要的条件等。其中每个状态都有自己定义，比如行走，蹲下，躺下，攻击，防守，三连击，俯冲，左移，右移等。

人们习惯把人或动物的某些连贯的行为定义为状态，所以状态其实不只是一个动作，它可以是好几个动作，或者好几段位移，也就是好几段执行程序。

这种好几个动作和好几段位移一起组成的组合，在程序中用状态来表示最符合逻辑。每种状态下不只是一个动作或一种位移，而是由很多个动作多段位移组合而成。

在游戏里，智能的机器人由于都是人设计出来的，行为方式也最符合人类的逻辑，所以状态机的方式制作AI最符合人类思维，也最容易被接受。

从面向程序的角度来看，状态可以从父类构建开始，并且向不同的方向继承并衍生，最终再把所有的状态类集中到控制状态的状态控制器中。

下面我们就以图和文的方式构建一个 AI 状态机：

我们以 AIStateBase 为状态基础类，基础类中有一个识别状态类的变量，可以是整数，也可以是枚举，和三个必要的接口，更新函数 Update() ，进入状态事件引发的事件函数 OnEnter()，退出状态事件引发的事件函数 OnExit()。这三个函数足以概括状态的出、入、以及自我循环更新三个动作，状态机定义下也只有这三个动作可以做。

接下来，我们开始扩展状态机的功能，以跑步动作状态为例：

在进入跑步动作状态时，表现为，机器人有跑步动画，并且向前移动。

实现跑步状态，首先继承父类 AIStateBase 并且把跑步状态类命名为 AIRunState。然后再对 AIRunState 进行编写，在进入状态时也就是 OnEnter 函数中编写机器人播放跑步的动画并让动画不断循环播放，然后在更新函数 Update 中开启不断向前移动的位置变化。当不再需要移动时，也就是退出跑步状态事件中，OnExit 里调用停止播放动画，也可以不停止播放，因为下一个状态肯定会播放其他动画，不如让他们插值过度下动画看起来会更顺滑。

实现了跑步状态，可以引申出其他和它基本相同的状态，它们可以完全按照跑步状态的方式实现，比如后退，侧移，漫步，打坐，跳跃，攻击等，它们都是只用到播放自身动画和持续位移组合的方式完成状态。对其他复杂状态来说，算是比较基本的状态。

现在我们来实现稍微复杂点的状态‘追击’状态。追击中有两个动作，一个是追，一个是攻击，不止是这些，我们还必须首先锁定目标，然后寻找追击的路径。当怪物进入‘追击’状态时，会锁定目标，然后不断向目标跑去，当跑到攻击范围内时，进行攻击。

我们定义一个‘追击’状态类，AIAttackState 类同样继承 AIStateBase。当‘追击’状态开始时，进入 OnEnter 函数时先锁定目标，把目标保存下来，并且寻找追击目标的路径 Path Find，寻路解决方案会在地图与寻路章节中详细介绍。接下来就是‘追击状态’的更新函数，每帧都会调用更新函数 Update，在Update中，检查目标是否已在攻击范围内，如果是则立刻播放攻击动画，并且调用目标的伤害接口使目标伤害，如果不在范围内则检查锁定目标是否移动，如果有移动就重新寻找路径，并且根据路径来进行位移。



