
---
layout: post
status: publish
published: false
title: <代号:南海> 游戏架构成形记
description: "unity3d 高级编程 主程 shader 漫反射 镜面反射 自发光 球面反射"
excerpt_separator: ===
tags:
- 书籍著作
- Unity3D
- 前端技术
---


<代号:南海>项目从头到现在由于目标的变化更换过很多次架构。

从最初的单机改为了现在的实时网络同步，

从原本的双端调用同一套核心AI算法，到现在客户端服从服务端调用命令来同步画面，

以及原本的C#语言编写UI逻辑，到现在更换为lua脚本编写UI逻辑，

以及最初使用json的http网络协议到现在使用protobuff的socket-tcp协议。

最终客户端架构定型为，使用lua编写UI逻辑并且使用ab更新lua脚本，客户端只播放服务端的指令来同步画面，网络协议使用protobuff。

客户端的架构特点，主要体现在文件夹管理、自动化程序、可更新补丁、渲染优化、程序优化上。

从文件夹的结构分布可以清晰的看出整个项目的资源、程序、文档的分布情况与特点。

我们编写了很多自动化程序来提高工作效率，包括Jenkins自动打包，Jenkins自动同步配置表，Jenkins自动重启服务器，一键生成xls数据，一键生成lightmap信息，一键生成资源检测报告，一键查找丢失脚本，一键打ab资源，一键导出地图数据，一键合并贴图，一键合并网格等等。这种类似的一键方式打破了人工时间的束缚，大大提高了生产效率，并且让部门与部门之间的沟通更加顺畅，也同时间接提高了其他部门的效率。

我们的在线更新方案，为Unity3D的ab资源更新方案，并且加入了lua的更新，使得当发现UI的bug时能在线即时更新补丁，每个资源可单独打包也可以分批合并打包。

渲染上的优化，主要体现在UI上的动静分离，scoureView的优化，地图资源，花草树木，建筑模型上。针对我们游戏特有的画面和资源类型，对游戏模型和动画数据进行优化，包括减小数目和花草的面数让动态合批起作用，对建筑模型进行合并贴图合并模型的方式减少drawcall，再加入针对当前游戏摄像头移动方式的特有的LOD方式减少同屏的网格数目。并且借用一键资源检测系统，对资源的分布、设置、数据大小进行监测。

在程序优化上，我们不断的检查程序规范，每隔一段时间针对当前的代码进行一次全面的review，同时为了提高各位同事的技术能力，每周都进行技术分享，以增进团队技术与交流。针对特定的算法，比如寻路，排序，检测碰撞算法，图形算法，AI算法等做了重点的优化。

=========================================================

服务端也经历了一阵巨大的架构更换，从原本的HTTP的web架构到现在的socket-tcp架构，从逻辑端上做了很大的调整。

最终成型为现在的是以lua为主编写游戏逻辑，以分布式为主的服务器架构。

架构的主要核心理念是，以网关，数据库，redius为媒介，平行分布逻辑服务器，让逻辑服务器能更快更便宜的进行扩展，让成本随着人数的增加而只是线性的上升。

不同类型的服务器之间的通讯可以使用网关和存储媒介来进行。比如现在只有两种服务器类型，一个是游戏逻辑服务器，一个是联盟服务器，联盟服务器的主要作用是操作联盟数据，主要目的是让联盟数据有统一的操作程序，不让它分散到各个游戏服是因为同步数据有着极大的困难。

服务端中的数据存储，主要以mysql为主，玩家上线时读取mysql数据，下线时存储数据，中间每隔5-10分钟随机存储一次。

服务端的逻辑部分核心为AI与道路的建设与连线，AI结合了状态机和时间轴手法，对每个建筑，每个人物进行状态检测、更改、同步。

道路使用线段相交的图形计算方式计算道路相交点以及点与点之间的连线，然后使用a星寻路算法对人物移动进行寻路。

