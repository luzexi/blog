---
layout: post
status: publish
published: false
title: 《Unity3D高级编程之进阶主程》第十章，地图与寻路(二) 寻路网格构建
description: "unity3d 高级编程 主程 地图 navmesh 寻路"
excerpt_separator: ===
tags:
- 书籍著作
- Unity3D
- 前端技术
---

### 寻路网格构建

上一节我们了解了A星寻路的算法及其优化，A星寻路只是算法，需要配套的模块和工具链支撑，单独的一个A星无法运作因为它只是一个算法。

需要什么样的模块和工具链呢，我们这节就来讲一讲，最重要的配套模块‘寻路网格构建’。除了网格构建外，还有障碍物的构建，以及地图和地形的构建，最后再配上A星寻路，才形成最终的地图和寻路。

###### 1.用二维数组构建虚拟的方形网格

最最简单的也是最最易于理解的网格构建方式要属二维网格，它是一个二维数组，每个元素就代表一个方格，方格中数字0代表无障碍，1代表有障碍，或者也可以是数字1代表障碍难度为1，比1大的数字代表更高的障碍难度，数字越大障碍难度越大，到达某个数字比如999，则认为该障碍难度完全无法跨越。

举个二维网格的例子：

		[0][0][0][0][0][0]
		[1][1][0][0][1][1]
		[1][1][0][1][1][1]
		[0][1][0][0][1][1]
		[0][0][0][1][1][1]

这是一个 5 * 6 的二维数组，0代表无障碍，1代表有障碍。我们很清晰的看到这张地图中有多少个障碍点，在这张地图中，我们从任意一个无障碍点出发都能到达任意一个无障碍点，因为所有的0都是联通的。

用二维数组代表地图是比较抽象的，那么怎么和地图匹配，怎么与地图真正的关联起来呢？

我们在脑海中需要把地图也切成 5 * 6 这样30块地图，比如这个张地图总共大小为 50米 * 60米 的大小，假如左下角为[0,0]位置，我们从0，0点开始，10，10点到0，0点为一个方块与[0,0]这个点关联，坐标10，10到坐标20，20为一个方块与[1,1]这个点关联，0，10点开始，10，20点到0，10点的方块与[0,1]这个点关联，依次类推。

每个在地图上的10 * 10大小的一个块正方形的区域，都与数组关联。这样我们在用A星寻路在数组中寻路后的结果都可以一一对应到地图上。

比如，我们寻路到从[0,0]点开始，到[1,4]点的路径为，[0,0]->[1,0]->[2,0]->[2,1]->[2,2]->[2,3]->[2,4]->[1,4]，反应到地图上时，是0，0点开始移动，先移动到第一个方块(0,0)到(10,10)点的中点，也就是坐标(5,5)的点位上，再移动到(10,0)与(20，10)这个方块区域的中点上，即(15,5)坐标点位上，再移动到(20,0)与(30,10)这个方块区域的中点上，即(25,5)坐标点位上，依次类推，直到移动到最后一个点位，即(10,40)与(20,50)这个方块区域的中点上，即(15,45)这个坐标上，到达终点。

因此A星寻路结束后，给出了[0,0]->[1,0]->[2,0]->[2,1]->[2,2]->[2,3]->[2,4]->[1,4]的数组上的坐标路径，在实际地图中则移动的路径为(5,5)->(15,5)->(25,5)->(25,15)->(25,25)->(25,35)->(25,45)->(15,45)的坐标点位顺序。

相当于把整个地图想象成一个矩形，把矩形横切N刀，竖切N刀，成了一个与二维数组匹配的方块地图，每个方块与数组中的一个元素相关联，当我们使用A星算法从数组中算出一个具体的路径时，可以根据这个数组中的路径，来匹配地图上的点位。

如果这个地图很大，但数组的大小很小，就无法实现细腻的碰撞体，所以我们需要权衡内存占用量与地图细节的问题，即多大的数组与当前的地图才能匹配的更好，数组不能过大，因为过大的数组会造成内存的浪费，又不能过小，因为过小的数组使得地图的障碍细节无法得到完美的体现。所以我们在决定数组多少的时候，需要考虑的是整个地图的大小，以及最小障碍物为多大，来决策究竟需要用多大的数组。

这些切割与关联都是由我们的脑袋想象出来的，过于抽象，毕竟我们在做游戏项目的时候，抽象的东西如果无法可视化的话，就会变得难以运用，至少是难以灵活的编辑和扩展。

那么如何将这个抽象的方块可视化呢，最简单的方法就是用Excel方式，建立一个Excel，在Excel表中填入一个与数组相等大小的矩形方格块，在方格内填入颜色与数字，绿色代表可行区域，并填入0，红色代表不可行区域，并填入1。这样在Excel内就可以设置地图的障碍物，以及障碍物的大小，一眼就能知道，那些标记为红色的方格是障碍物，哪些地方是可通行的，哪些地方是不可通行的，一目了然。最后我们把这个Excel里的数据导出到文件，再在游戏开始时读取文件中的数据，得到地图的二维数组的方格数据。

除了Excel，我们还可以使用自行用UnityEditor UI编写的地图编辑窗口，把地图大小，方格大小，障碍物等以可视化的形式放在 UnityEditor UI编辑窗口中，并编写保存数据到文件，和从文件读取地图数据的功能和按钮，这样一个地图编辑窗口就形成了。

如果这种可视化还不够，那么就要在具体的地图上做文章了，把具体的整个地图加载并渲染在画面上，然后在地图上用颜色方块的方式把地图切分成各个块状，以具体地图为背景，来编辑地图障碍与大小。这也带来更加多的编写和维护工作，但也同时是非常值得的可视化网格编辑器。


### 2.用路点系统构建寻路路线图

用二维数组的方式来构建寻路的基础数据有一定的局限性。当场景特别大，你就要存储特别大的一个数组，编辑场景的复杂度也提高了，因为你要把所有的障碍点都设置一遍，工作量比较大。

二维数组下的寻路路径最多是8方向的，上，下，左，右，左上，左下，右上，右下，寻路后的行走时会比较不真实，感觉就是直来直去的，要么90度方向行走，要么180度方向行走，要么45度方向行走，没有其他角度的行走姿势，让人感觉会不到真实。

路点系统则没有二维数组的这些缺点。路点系统也是一个易于理解的系统，它由很多个点构成，这些点我们称它们为路点，即路上的点，这些路点需要我们手动在地图上放进去，每个路点中都存储了坐标，ID，以及与哪些路点相连的数据。

我们在地图中，放入了很多个路点，并且为这些路点配置了连线，于是就有了这幅画面：

		图片脑补

地图中每个路点都会有与其他某些路点相连接的线，我们可以称它们为路线，由路点与路点之间连线而成。

如果把地图里的路点和路线铺设的更加复杂一点时，所有的点和线都拼成了一张网：

		图片脑补

这张网中，只要我们得到某个点，就能根据这些路点和路线，用A星的算法来寻路到目的地。即，起点为，与起点最近的路点，寻路到，与终点最近的路点，的一条路径。如图：

		图片脑补

路点系统很容易理解，不过需要一些可视化的编辑器的支撑，因为所有的路点都需要在既有的地图上编辑，所以编写一个专门的地图编辑器是必不可少的，没有地图编辑器的话至少也需要路点编辑器，可保存路点数据到文件，和从文件加载路点数据，以及增加路点，减少路点，添加和减少路点连接信息。

路点系统的缺点也是比较严重的，它任然需要大量的工作量来编辑可寻路的路点信息与连线。

路点系统的寻路方式无法识别碰撞而只能用路点的形式来绕过障碍，因此在使用路点系统为主要寻路方式的游戏中，人物的行走只能通过寻路的方式来做，无法使用自定义的随意行走方式，因为那样就需要识别障碍或者碰撞检测，而路点系统无法识别障碍也无法使用碰撞检测。

另外当在大块空地上做寻路时，需要在这个大块空地上手动添加很多的路点，才能平滑的适应各种寻路，虽然没什么难度，但对人来说重复的工作量比较大。


### 3.平面三角形网格的构建 -- Navigation Mesh

路点系统虽然直观，门槛低，上手简单，但枯燥的重复工作量比较大，更糟糕的是它也无法识别障碍区域，行走的路线也依赖路点的路线。

Navmesh是最耳熟能详的寻路解决方案，其实质是三角形构建的网格 + A星的寻路方式，在2D和3D游戏上的都普遍使用了Navmesh的解决方案。



### 4.三维的三角形网格构建


1，Navmesh算法。

2，生成Navmesh网格，多层网格数据输出。

http://blianchen.blog.163.com/blog/static/13105629920103211052958/
http://blianchen.blog.163.com/blog/static/13105629920103614613291/
http://blianchen.blog.163.com/blog/static/131056299201037102315211/
http://blianchen.blog.163.com/blog/static/13105629920103811451196/
http://blianchen.blog.163.com/blog/static/13105629920103911258517/
http://blianchen.blog.163.com/blog/static/131056299201031293039882/

3，导入导出，自动生成Navmesh网格，再手工调节。

RecastNavigation-NavMesh生成原理
https://blog.csdn.net/you_lan_hai/article/details/77428858

navmesh高度结构
http://critterai.org/projects/cainav/doc/html/6fb3041b-e9be-4f03-868b-dcac944df19b.htm

关于 Unity NavMesh 数据的导出和使用
http://www.cnblogs.com/yaukey/p/3585226.html

可以用路点+navmesh的形式做图。因为路点消耗少，在城市道路上，在没有怪物的情况下可以做到很少的消耗。而在战斗中则需要整个地面有寻路路线，就需要navmesh的作用。


